/*! rha-server 10-08-2015 */
function RequestController(a,b,c,d,e,f,g){function h(a){e.show(e.alert().title("Error").content("Sorry, something went wrong.\n\n"+JSON.stringify(a)).ariaLabel("Error Alert").ok("Back"))}function i(){var a=c.defer(),d=new m("push",l.path,b.newObject);return d.then(function(b){a.resolve(b)})["catch"](function(b){a.reject(b)}),a.promise}function j(){var a=c.defer(),d=new m("update",l.path+"/"+g.$content.focusedData.key,b.newObject);return d.then(function(b){a.resolve(b)})["catch"](function(b){a.reject(b)}),a.promise}function k(a){var b=c.defer(),d=new m("remove",l.path);return d.then(function(a){b.resolve(a)})["catch"](function(a){b.reject(a)}),b.promise}var l=f;b.newObject={},g.$content.focusedData&&(b.newObject=g.$content.focusedData);var m=function(){var b=c.defer(),e={};return e.auth=l.auth,e.action=arguments[0],e.path=arguments[1],e.params=arguments[2],d(e).then(function(c){a.debug("Completed Request."),b.resolve(c)})["catch"](function(c){a.error(JSON.stringify(c)),b.reject(c)}),b.promise},n=function(a){b.eventForm={},b.newObject={},e.hide(a)};b.hide=function(){e.hide()},b.cancel=function(){b.eventForm={},e.cancel()},b.answer=function(a){"push"===l.action?i().then(n)["catch"](h):"update"===l.action?j().then(n)["catch"](h):"remove"===l.action?k().then(n)["catch"](h):e.hide(a)}}var adminApp=angular.module("adminApp",["ngMaterial","ui.router","firebase","angularMoment","mdLayout","user","home","admin","cmsClient","cmsAdmin"]);adminApp.constant("AUTO_ANON",!1),adminApp.constant("FBURL","https://dev-nurha.firebaseio.com"),adminApp.constant("APPURL","https://stage-nurha.firebaseapp.com/"),adminApp.config(["$urlRouterProvider","$logProvider","$mdThemingProvider","cmsClientProvider","FBURL",function(a,b,c,d,e){b.debugEnabled(!0),a.otherwise("/"),d.setContentUrl(e+"/app/content"),c.theme("default").backgroundPalette("grey").primaryPalette("deep-purple").accentPalette("pink")}]),adminApp.run(["$log","$rootScope","$state","$stateParams",function(a,b,c,d){b.$state=c,b.$stateParams=d,b.$on("$stateChangeSuccess",function(a,c,d,e,f){b.$state.$back=e}),b.$on("$stateChangeError",function(d,e,f,g,h,i){a.error("$stateChangeError:",i),"AUTH_REQUIRED"===i?c.go("user.login"):c.go(b.$state.$back)})}]),angular.module("admin.directives",[]).directive("cmsList",[function(){return{scope:{data:"=",edit:"="},templateUrl:"modules/admin/templates/content-list-template.html"}}]).directive("cmsItem",[function(){var a=function(a){return"events"===a.parent?{title:a.title,subtitle:a.locationString,caption:a.dateString}:"halls"===a.parent?{title:a.title,subtitle:a.locationString,caption:a.representative.name+"  "+a.representative.email}:"people"===a.parent?{title:a.name,subtitle:a.email,caption:a.title}:void 0};return{scope:{item:"=",edit:"="},controller:function(a){a.editItem=function(b){a.edit(b,a.item.parent,a.item.key)}},transclude:!0,templateUrl:"modules/admin/templates/content-item-template.html",link:function(b,c,d,e){var f=new a(b.item);b.keys=f}}}]);var adminModule=angular.module("admin",["admin.directives"]);adminModule.config(["$stateProvider",function(a){a.state("admin",{url:"/admin","abstract":!0,controller:"AdminController",templateUrl:"modules/admin/templates/admin-layout.html",resolve:{currentAuth:function(a){return a.requireAuth()}}}).state("admin.index",{url:"",views:{"admin-content":{templateUrl:"modules/admin/templates/admin-dashboard-index.html"}},data:{title:"Dashboard"}}).state("admin.content",{url:"/content",views:{"admin-content":{templateUrl:"modules/admin/templates/admin-content-index.html"}},data:{title:"Content Management"}}).state("admin.messages",{url:"/messages",views:{"admin-content":{templateUrl:"modules/admin/templates/admin-messages-index.html"}},data:{title:"Messages"}})}]),adminModule.controller("AdminController",["$log","$cmsClient","$scope","$state","$q","$mdDialog","UserService",function(a,b,c,d,e,f,g){c.$content={},c.$content.focusedData={};var h=g.getCurrentAuth();c.init=function(){c.$content=b.getContent().then(function(a){c.$content=a})};var i=function(a,b,d,e){f.show({controller:RequestController,templateUrl:b,clickOutsideToClose:!0,escapeToClose:!0,targetEvent:a,locals:{data:{action:d,path:e,auth:h},parentScope:c}}).then(function(a){c.alert='You said the information was "'+a+'".'},function(){c.alert="You cancelled the dialog."})};c.create=function(a,b){c.$content.focusedData=null,i(a,"modules/admin/templates/dialog-new-event.html","push","/app/content/"+b)},c.edit=function(a,b,d){c.$content.focusedData=c.$content.events[d],i(a,"modules/admin/templates/dialog-new-event.html","update","/app/content/"+b)}}]);var homeModule=angular.module("home",[]);homeModule.config(["$stateProvider",function(a){a.state("home",{url:"/","abstract":!0,template:"<ui-view/>"}).state("home.index",{url:"",views:{"":{controller:"HomeController",templateUrl:"modules/home/home.html"}}})}]),homeModule.controller("HomeController",["$log","$scope","$mdToast","FBURL","APPURL",function(a,b,c,d,e){var f=new Firebase(d+"/messages"),g=f.push(),h={bottom:!0,top:!1,left:!1,right:!0},i=function(){return Object.keys(h).filter(function(a){return h[a]}).join(" ")};b.appUrl=e,b.submit=function(){b.contact.$valid&&(b.messageData.submitAt=Firebase.ServerValue.TIMESTAMP,b.messageData.submitAtString=Date(Firebase.ServerValue.TIMESTAMP),g.set(b.messageData,function(d){d?(a.error("Error submitting contact message:",d),c.show(c.simple().content("Error!").position(i()).hideDelay(5e3))):(a.debug("Submitted contact message."),b.messageData={},b.contact.$setUntouched(),b.contact.$setPristine(),c.show(c.simple().content("Sent!").position(i()).hideDelay(5e3)))}))}}]);var userFactory=angular.module("user.factories",[]);userFactory.factory("User",["$q","$rootScope","UserFactory","FBURL",function(a,b,c,d){var e,f=a.defer();return function(a){if(a.uid){var g=new Firebase(d+"/users/"+a.provider+"/"+a.uid);e=new c(g),e.$updateUser(),e.$bindTo(b,"userData").then(function(){b.auth=e.$auth.$getAuth(),f.resolve(e)})["catch"](function(a){f.reject("Error binding $rootScope.userData",a)})}else f.reject("User(userAuth): userAuth not inputted.");return f.promise}}]),userFactory.factory("UserFactory",["$rootScope","$firebaseAuth","$firebaseObject","$q","FBURL",function(a,b,c,d,e){var f=new Firebase(e);return c.$extend({$$defaults:{$auth:b(f)},$updateUser:function(){var a=d.defer(),b={};return angular.copy(this.$auth.$getAuth(),b),delete b.auth,this.auth=b,b.password&&(this.auth.email=b.password.email),this.$ref().update(this.auth,function(b){b?a.reject(b):a.resolve()}),a.promise},$logout:function(){this.$destroy(),this.$auth.$unauth()}})}]);var userModule=angular.module("user",["user.services","user.factories"]);userModule.run(["UserService",function(a){a.init()}]),userModule.config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("user",{url:"","abstract":!0,controller:"UserController",template:"<ui-view/>"}).state("user.profile",{url:"/profile",views:{"":{templateUrl:"modules/user/templates/user.profile.html"}},resolve:{currentAuth:function(a){return a.requireAuth()}}}).state("user.login",{url:"/login",views:{"":{templateUrl:"modules/user/templates/user.login.html"}}}).state("user.logout",{url:"/logout",template:"<ui-view/>",controller:function(a,b,c){a.debug("Logging out."),c.logout(),b.go("user.login",{alert:"You have been logged out."})}})}]),userModule.controller("UserController",["$log","$scope","$state","UserService",function(a,b,c,d){var e="admin.index",f=function(){return b.incomingUser.email&&b.incomingUser.password},g=function(){alert("Oops, we couldn't log you in.")},h=function(){alert("Please enter your email and password to log in.")};b.incomingUser={},b.loginWithPassword=function(){f()?d.loginWithPassword(b.incomingUser,function(){c.go(e)},function(b){a.error("Login error:",b),g()}):h()}}]);var userService=angular.module("user.services",["user.factories"]).service("UserService",["$log","$q","$firebaseAuth","FBURL","User","AUTO_ANON",function(a,b,c,d,e,f){var g,h,i=new Firebase(d),j=c(i);return g={init:function(){var b=function(){a.debug("Authenticating anonymous user..."),g.loginAnonymously().then(function(b){e(b).then(function(b){h=b,a.debug("Anonymous user loaded",h)})["catch"](function(b){a.error("Error loading new anonymous user",b)})})["catch"](function(b){a.error("Error authenticating anonymous user",b)})},c=function(){e(g.getCurrentAuth()).then(function(b){h=b,a.debug("Existing user loaded",h)})["catch"](function(b){a.debug("Error loading existing user",b)})};a.debug("Checking for existing user..."),g.getCurrentAuth()?c():1==f&&b()},getCurrentAuth:function(){return j?j.$getAuth():null},requireAuth:function(){return j.$requireAuth()},getRef:function(){return h.$ref()},createUser:function(b,c,d){g.logout(),j.$createUser({email:b.email,password:b.password}).then(function(c){return a.debug("Created user:"+c.uid),j.$authWithPassword({email:b.email,password:b.password})}).then(function(a){g.init(),c&&c()})["catch"](function(b){a.error("Error: ",b)})},loginWithPassword:function(b,c,d){g.logout(),j.$authWithPassword({email:b.email,password:b.password}).then(function(b){a.debug("User",b.uid,"logged in."),g.init(),c&&c()})["catch"](function(b){a.error("User login failed:",b),d&&d(b)})},loginAnonymously:function(){var a=b.defer();return j.$authAnonymously().then(function(b){a.resolve(b)})["catch"](function(b){a.reject(b)}),a.promise},logout:function(b,c){j.$getAuth()?(h.$logout(),a.debug("User successfully logged out."),b&&b()):(a.debug("User tried to logout but is not logged in."),c&&c())}}}]);